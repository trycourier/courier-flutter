name: Test Trigger

on:
  push:
    branches: [master]
  workflow_dispatch:
  pull_request:
    branches: [master]

jobs:
  tests-on-push:
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - name: Dispatch App Build
        run: |
          curl -sS --fail-with-body -X POST \
            -H "Authorization: token ${{ secrets.AUTOMATION_ACCESS_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/trycourier/mobile-automation-tests/dispatches \
            -d '{"event_type": "iOS-Flutter", "client_payload": {"sha":"'"${{ github.sha }}"'","ref":"'"${{ github.ref }}"'"}}'
          curl -sS --fail-with-body -X POST \
            -H "Authorization: token ${{ secrets.AUTOMATION_ACCESS_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/trycourier/mobile-automation-tests/dispatches \
            -d '{"event_type": "Android-Flutter", "client_payload": {"sha":"'"${{ github.sha }}"'","ref":"'"${{ github.ref }}"'"}}'

  tests-on-pr:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Dispatch App Build
        run: |
          curl -sS --fail-with-body -X POST \
            -H "Authorization: token ${{ secrets.AUTOMATION_ACCESS_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/trycourier/mobile-automation-tests/dispatches \
            -d "$(jq -n \
                  --arg et 'iOS-Flutter' \
                  --arg prnum '${{ github.event.pull_request.number }}' \
                  --arg sh '${{ github.event.pull_request.head.sha }}' \
                  '{event_type:$et, client_payload:{pr:$prnum, sha:$sh}}')"
          curl -sS --fail-with-body -X POST \
            -H "Authorization: token ${{ secrets.AUTOMATION_ACCESS_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/trycourier/mobile-automation-tests/dispatches \
            -d "$(jq -n \
                  --arg et 'Android-Flutter' \
                  --arg prnum '${{ github.event.pull_request.number }}' \
                  --arg sh '${{ github.event.pull_request.head.sha }}' \
                  '{event_type:$et, client_payload:{pr:$prnum, sha:$sh}}')"

  tests-manual:
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - name: Dispatch App Build
        run: |
          curl -X POST \
            -H "Authorization: token ${{ secrets.AUTOMATION_ACCESS_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/trycourier/mobile-automation-tests/dispatches \
            -d '{"event_type": "iOS-Flutter", "client_payload": {"sha":"'"${{ github.sha }}"'","ref":"'"${{ github.ref }}"'"}}'
          curl -X POST \
            -H "Authorization: token ${{ secrets.AUTOMATION_ACCESS_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/trycourier/mobile-automation-tests/dispatches \
            -d '{"event_type": "Android-Flutter", "client_payload": {"sha":"'"${{ github.sha }}"'","ref":"'"${{ github.ref }}"'"}}'
